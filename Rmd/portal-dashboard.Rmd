---
title: "CSBC/PS-ON Knowledge Portal"
subtitle: "Resource & Activity Overview"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: lumen
    runtime: shiny
---

```{r setup, include=TRUE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(shiny)
library(crosstalk)
library(DT)
library(ggridges)
library(synapser)
```

```{r, include=FALSE}
synLogin()
csbc_summary_df <- synTableQuery('select * from syn11958165')$asDataFrame()

csbc_summary_df$createdOn_file <- lubridate::as_datetime(floor(csbc_summary_df$createdOn_file/1000))
csbc_summary_df$modifiedOn_file <- lubridate::as_datetime(floor(csbc_summary_df$modifiedOn_file/1000))
csbc_summary_df$createdOn_project <- lubridate::as_datetime(floor(csbc_summary_df$createdOn_project/1000))
csbc_summary_df$modifiedOn_project <- lubridate::as_datetime(floor(csbc_summary_df$modifiedOn_project/1000))
```

```{r}
project_vars <- c("projectId", "name_project", "institution", "consortium",
                  "grantNumber", "grantType", "teamMembersProfileId",
                  "teamProfileId", "createdOn_project", "modifiedOn_project",
                  "publication_count", "publication_geodata_produced")
count_vars <- c("fileId", "individualID", "specimenID", "cellLine",
                "assay", "tool")
center_study_summary_df <- csbc_summary_df %>% 
    mutate(tool = ifelse(!is.na(softwareLanguage), study, NA)) %>% 
    group_by(.dots = c(project_vars, "study")) %>% 
    summarise_at(.vars = count_vars,
                 .funs = funs(n_distinct(., na.rm = TRUE))) %>% 
    replace_na(list(study = "Not Annotated")) %>% 
    mutate(study = ifelse(fileId == 0, NA, study))
```


```{r}
center_summary_df <- center_study_summary_df %>% 
    group_by(projectId) %>% 
    summarise(study = n_distinct(study, na.rm = TRUE)) %>% 
    ungroup() %>% 
    left_join(
        center_study_summary_df %>% 
            select(-study) %>% 
            group_by(.dots = project_vars) %>% 
            summarise_all(sum),
        by = "projectId"
    )
```



Portal at a Glance
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

---

**About**

Welcome to the CSBC/PS-ON Knowledge Portal Dashboard!

---


Row
-----------------------------------------------------------------------

### Centers

```{r}
centers <- n_distinct(center_study_summary_df$projectId)
valueBox(centers, icon = "fa-university")
```

### Files

```{r}
files <- sum(center_study_summary_df$fileId)
valueBox(files, icon = "fa-file")
```

### Samples

```{r}
samples <- sum(
    sum(center_study_summary_df$individualID),
    sum(center_study_summary_df$cellLine),
    sum(center_study_summary_df$specimenID)
)
valueBox(samples, icon = "fa-tag")
```


### Publications

```{r}
pubs <- csbc_summary_df %>% 
    group_by(projectId) %>% 
    summarise(value = unique(publication_count)) %>% 
    pull(value) %>%
    sum()

valueBox(pubs, icon = "fa-pencil")
```


Row
-----------------------------------------------------------------------

### Data Shared

```{r}
centers_w_files <- center_summary_df %>%
    group_by(projectId) %>%
    summarize(file_count = sum(fileId)) %>%
    filter(file_count > 0) %>% nrow()
gauge(centers_w_files, min = 0, max = centers)
```

> (out of all Centers)


### Files in Studies

```{r}
files_w_study <- center_study_summary_df %>% 
    filter(!is.na(study),
           study != "Not Annotated") %>% 
    .[["fileId"]] %>% 
    sum()
    
gauge(files_w_study, min = 0, max = files)
```

> (out of all files)


Row
-----------------------------------------------------------------------

### Data upload frequency over time
```{r}
projects_w_files <- center_summary_df %>%
  group_by(projectId) %>%
  summarize(file_count = sum(fileId)) %>%
  filter(file_count > 0) %>%
  pull(projectId)

plot.dat <- filter(csbc_summary_df, projectId %in% projects_w_files)
plot.dat <- plot.dat[,c('fileId', 'projectId', 'createdOn_file', 'study')]
plot.dat <- mutate(plot.dat, date = format(as.Date(createdOn_file), "%y-%m"))
plot.dat$study[is.na(plot.dat$study)] <- 'Other files'

ggplot(plot.dat, aes(x = date , y = study)) +
  geom_density_ridges(aes(fill = study), alpha = 0.5, scale = 4,  scale = 3, size = 0.3) +
  scale_x_discrete(expand = waiver()) + theme(legend.position = "none", axis.text.x = element_text(angle = 55, hjust = 1))
```

> (All files by study)

Center Summaries
=====================================

Sidebar {.sidebar}
-----------------------------------------------------------------------

---

**Center Activity**

Select a row in the table to view details about a Center.

---

```{r}
# followed example here... can probably simplify
# https://github.com/rstudio/DT/issues/300

UpdateInputs <- function(data, session) {
    updateTextInput(session, "projectId", value = unname(data["projectId"]))
}

textInput("projectId", "Project", "")

formData <- reactive({
    sapply(c("projectId"), function(x) input[[x]])
})

observeEvent(input$center_summary_rows_selected, {
    if (length(input$center_summary_rows_selected) > 0) {
        data <- center_summary_df[input$center_summary_rows_selected, ]
        UpdateInputs(data, session)
    }
})
```

Row
-----------------------------------------------------------------------

### Center Snapshot

```{r}
fillRow(
    DT::dataTableOutput("center_summary", width = "100%")
)

output$center_summary <- DT::renderDT({
    datatable(center_summary_df, 
              selection = list(
                  mode = 'single', selected = c(3)
              ),
              options = list(
                  scrollX = TRUE
              ),
              rownames = FALSE
    ) %>%
        formatStyle(
            'fileId',
            backgroundColor = styleEqual(0.0, 'lightpink')
        )
}, server = FALSE
)
```


Row {.tabset}
-----------------------------------------------------------------------

### Overall Center Contributions

```{r}
plotly::plotlyOutput("center_details")
output$center_details <- plotly::renderPlotly({
    if (length(input$center_summary_rows_selected)) {
        selected_project <- center_summary_df[[input$center_summary_rows_selected, "projectId"]]
        center_df <- center_summary_df %>% 
            filter(projectId == selected_project)
        print(center_df)
        
        p <- center_df %>% 
            select(-one_of(project_vars)) %>% 
            gather(attr, count) %>% 
            ggplot(aes(x = 1, y = count)) +
            geom_col() +
            xlab("") +
            facet_grid(. ~ attr, scales = "free_y") +
            theme(axis.text.x = element_blank(),
                  axis.ticks.x = element_blank())
        ggplotly(p)
    }
})

```

### Contributions by Study

```{r}
plotly::plotlyOutput("center_study_details")
output$center_study_details <- plotly::renderPlotly({
    selected_project <- center_summary_df[[input$center_summary_rows_selected, "projectId"]]
    center_df <- center_summary_df %>%
        filter(projectId == selected_project)

    p <- center_df %>%
        select(projectId) %>%
        left_join(center_study_summary_df, by = "projectId") %>%
        select(-one_of(project_vars)) %>%
        gather(attr, count, -study) %>%
        ggplot(aes(x = 1, y = count)) +
        geom_col() +
        xlab("") +
        facet_grid(study ~ attr, scales = "free_y") +
        theme(axis.text.x = element_blank(),
              axis.ticks.x = element_blank(),
              strip.background.y = element_blank(),
              strip.text.y = element_text(angle = 0, hjust = 0))
    ggplotly(p)
})
```






